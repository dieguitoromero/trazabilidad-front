<div class="mis-compras-wrapper">
  <h2 class="title" (click)="volverATodosLosDocumentos()">Mis Compras</h2>

  <!-- Vista cuando falta el par√°metro clienteId en la URL -->
  <div class="cliente-id-requerido" *ngIf="!loading && clienteIdRequerido">
    <div class="cliente-id-requerido__icon">‚ö†</div>
    <h3 class="cliente-id-requerido__title">Informaci√≥n requerida</h3>
    <p class="cliente-id-requerido__message">
      No se ha proporcionado la informaci√≥n necesaria para acceder a esta secci√≥n.
    </p>
    <p class="cliente-id-requerido__submessage">
      Por favor, verifica que la URL contenga los par√°metros necesarios e intenta nuevamente.
    </p>
  </div>

  <div class="search-row" *ngIf="!clienteNoEncontrado && !clienteIdRequerido">
    <input type="text" placeholder="Buscar por N¬∞ de pedido" [(ngModel)]="searchTerm" (keyup.enter)="buscar()"
      (input)="onInputChange()" />
    <button type="button" class="search-btn" aria-label="Buscar"
      (click)="buscar(); $event.preventDefault(); $event.stopPropagation();">
      üîç
    </button>
  </div>

  <div class="loading" *ngIf="loading">Cargando compras...</div>
  <div class="error" *ngIf="!loading && error && !clienteNoEncontrado && !clienteIdRequerido">No se pudo cargar desde el
    servicio, mostrando
    datos locales.</div>

  <!-- Vista cuando no se encuentra el cliente -->
  <div class="cliente-no-encontrado" *ngIf="!loading && clienteNoEncontrado">
    <div class="cliente-no-encontrado__icon">‚ö†</div>
    <h3 class="cliente-no-encontrado__title">Cliente no encontrado</h3>
    <p class="cliente-no-encontrado__message">
      No se encontr√≥ informaci√≥n para el cliente con RUT <strong>{{ rut }}</strong>.
    </p>
    <p class="cliente-no-encontrado__submessage">
      Por favor, verifica que el RUT sea correcto e intenta nuevamente.
    </p>
  </div>

  <div class="empty" *ngIf="hasNoResults && !loading && !clienteNoEncontrado && !clienteIdRequerido">
    <div class="info-icon">i</div>
    <div class="text">No se encontr√≥ documento</div>
  </div>

  <div class="cards" *ngIf="!hasNoResults && !clienteNoEncontrado && !clienteIdRequerido"
    [class.loading-state]="loading">
    <div class="card" *ngFor="let c of filteredCompras; trackBy: trackByCompra">
      <div class="card-header">
        <div class="doc-title">
          {{ c.tipoDocumento }} N¬∞ {{ c.numeroDocumento }}
        </div>
        <div class="card-header-actions">
          <button class="detail-btn" (click)="verDetalle(c)">Ver detalle</button>
        </div>
      </div>

      <div class="meta">
        <div class="fecha">Fecha de compra: {{ c.fechaCompra | formatFechaCompra }}</div>
        <div class="dimensionado-row" *ngIf="c.esDimensionado">
          <span class="badge dimensionado">
            <img src="assets/dimensionado-icon.svg" alt="Dimensionado" />
            Dimensionado
          </span>
        </div>
      </div>

      <!-- Resumen de entrega - usa el mismo componente que la vista de detalle para consistencia -->
      <app-purchase-summary *ngIf="c.tipoEntrega || c.pickup" [compact]="true" [pickup]="c.pickup"
        [tipoEntrega]="getTipoEntregaLabel(c)" [direccionEntrega]="c.direccionEntrega">
      </app-purchase-summary>



      <!-- Stepper - usa el componente de la fuente de verdad (tracking-stepper-view) -->
      <div class="hide-on-mobile stepper-wrapper">
        <app-tracking-stepper-view [steps]="getTrackingSteps(c)" [orderDetails]="getOrderDetails(c)">
        </app-tracking-stepper-view>
      </div>


      <!-- Timeline detallado removido: solo se mostrar√° en la pantalla de detalle -->

      <div class="estado-movil show-on-mobile">
        <span class="estado-icon"><img src="assets/estado-icon.svg" alt="Estado" /></span>
        <span class="estado-text">Estado: {{ estadoActual(c) }}</span>
      </div>

      <!-- Facturas asociadas: SOLO para Notas de Venta (NVV) seg√∫n especificaci√≥n del backend -->
      <div class="facturas-asociadas-link"
        *ngIf="c.tipoDocumento === 'Nota de Venta' && c.facturasAsociadas && c.facturasAsociadas.length > 0">
        <a (click)="toggleAsociadas(c)">Ver facturas asociadas ({{ c.facturasAsociadas.length }})</a>
      </div>

      <div class="asociadas"
        *ngIf="c.tipoDocumento === 'Nota de Venta' && c.facturasAsociadas && c.facturasAsociadas.length > 0">
        <div class="asociadas-list" *ngIf="isAsociadasOpen(c)">
          <ng-container *ngFor="let f of c.facturasAsociadas; trackBy: trackByFactura">
            <div class="asociada-item" *ngIf="f && (f.numeroFactura || f.fechaEmision)">
              <span class="dot-bullet">‚Ä¢</span>
              <span class="asociada-text">Factura N¬∞ {{ f.numeroFactura }}<ng-container *ngIf="f.fechaEmision"> - {{
                  f.fechaEmision }}</ng-container></span>
              <button class="detail-btn small" [class.disabled]="!f.numeroFactura || f.numeroFactura === '0'"
                [disabled]="!f.numeroFactura || f.numeroFactura === '0'"
                (click)="verDetalleFactura(f.numeroFactura)">Ver detalle</button>
            </div>
          </ng-container>
        </div>
      </div>


      <div class="card-actions show-on-mobile">
        <!-- Mobile actions now handled by card-footer-actions which is unified -->
      </div>
    </div>
  </div>

  <!-- Bot√≥n "Mostrar m√°s" solo en la primera p√°gina -->
  <div class="show-more-container" *ngIf="shouldShowMoreButton">
    <button class="show-more-btn" (click)="mostrarMasPrimeraPagina()">
      M√°s compras
    </button>
  </div>

  <div class="pagination-row desktop-only"
    *ngIf="!hasNoResults && !clienteNoEncontrado && !clienteIdRequerido && totalPages > 1 && (page !== 1 || showMoreFirstPage)">
    <button class="pagination-arrow" [class.disabled]="page === 1" (click)="goToPage(page - 1)" [disabled]="page === 1">
      ‚Äπ
    </button>
    <button class="page-box" *ngFor="let p of getVisiblePages(); trackBy: trackByPage" [class.active]="p === page"
      [class.next-page]="p === page + 1" [class.prev-page]="p === page - 1" [class.ellipsis]="p === '...'"
      [disabled]="p === '...'" (click)="handlePageClick(p)">
      {{ p }}
    </button>
    <button class="pagination-arrow" [class.disabled]="page === totalPages" (click)="goToPage(page + 1)"
      [disabled]="page === totalPages">
      ‚Ä∫
    </button>
  </div>

  <!-- Pager condensado m√≥vil -->
  <div class="mobile-condensed-pager"
    *ngIf="!hasNoResults && !clienteNoEncontrado && !clienteIdRequerido && totalPages > 1 && (page !== 1 || showMoreFirstPage)">
    <button class="pagination-arrow" [class.disabled]="page === 1" (click)="goToPage(page - 1)" [disabled]="page === 1">
      ‚Äπ
    </button>
    <div class="pager-node" *ngFor="let p of condensedPager; trackBy: trackByPage" [class.active]="isPagerActive(p)"
      [class.neighbor]="isPagerNeighbor(p)" (click)="goToPage(p)">
      <span>{{ p }}</span>
    </div>
    <button class="pagination-arrow" [class.disabled]="page === totalPages" (click)="goToPage(page + 1)"
      [disabled]="page === totalPages">
      ‚Ä∫
    </button>
  </div>
</div>