<div class="mis-compras-wrapper">
  <h2 class="title">Mis Compras</h2>

  <div class="search-row">
    <input type="text" placeholder="Buscar por N¬∞ de pedido" [(ngModel)]="searchTerm" (keyup.enter)="buscar()"
      (input)="onInputChange()" />
    <button class="search-btn" aria-label="Buscar" (click)="buscar()">
      üîç
    </button>
  </div>

  <div class="loading" *ngIf="loading">Cargando compras...</div>
  <div class="error" *ngIf="!loading && error">No se pudo cargar desde el servicio, mostrando datos locales.</div>
  <div class="empty" *ngIf="hasNoResults && !loading">
    <div class="info-icon">i</div>
    <div class="text">No se encontr√≥ documento</div>
  </div>

  <div class="cards" *ngIf="!hasNoResults">
    <div class="card" *ngFor="let c of filteredCompras">
      <div class="card-header">
        <div class="doc-title">
          {{ c.tipoDocumento }} N¬∞ {{ c.numeroDocumento }}
        </div>
      </div>

      <div class="meta">
        <div class="fecha">Fecha de compra: {{ c.fechaCompra | formatFechaCompra }}</div>
        <div class="dimensionado-row" *ngIf="c.esDimensionado">
          <span class="badge dimensionado">
            <img src="/trazabilidad-app/assets/dimensionado-icon.svg" alt="Dimensionado" />
            Dimensionado
          </span>
        </div>
      </div>

      <div class="entrega-row" *ngIf="c.tipoEntrega">
        <span class="icon" *ngIf="c.tipoEntrega === 'Despacho a domicilio' || c.tipoEntrega === 'Retiro en tienda'">
          <img [src]="c.tipoEntrega === 'Despacho a domicilio' ? '/trazabilidad-app/assets/domicilio-icon.svg' : '/trazabilidad-app/assets/tienda-icon.svg'"
            alt="Entrega" />
        </span>
        <span class="entrega-text">
          {{ c.tipoEntrega }}{{ c.direccionEntrega ? ': ' + c.direccionEntrega : '' }}
        </span>
      </div>


      <div class="hide-on-mobile">
        <div class="stepper">
          <div class="step" *ngFor="let step of stepperSnapshot(c); let i = index" [class.active]="step.isActive"
            [class.completed]="step.isCompleted">
            <div class="icon-wrapper">
              <ng-container *ngIf="step.isCompleted; else pendingIcon">
                <img src="/trazabilidad-app/assets/estadoOk.svg" alt="ok" class="icon ok" />
              </ng-container>
              <ng-template #pendingIcon>
                <div class="icon pending"></div>
              </ng-template>
            </div>
            <div class="label">{{ step.label }}</div>
          </div>
        </div>
      </div>

      <!-- Timeline detallado removido: solo se mostrar√° en la pantalla de detalle -->

      <div class="estado-movil show-on-mobile">
        <span class="estado-icon"><img src="/trazabilidad-app/assets/estado-icon.svg" alt="Estado" /></span>
        <span class="estado-text">Estado: {{ estadoActual(c) }}</span>
      </div>

      <div class="asociadas hide-on-mobile" *ngIf="c.facturasAsociadas && c.facturasAsociadas.length > 0">
        <!-- Button moved to footer -->
        <div class="asociadas-list" *ngIf="isAsociadasOpen(c)">
          <ng-container *ngFor="let f of c.facturasAsociadas">
            <div class="asociada-item" *ngIf="f && (f.numeroFactura || f.fechaEmision)">
              <span class="dot-bullet">‚Ä¢</span>
              <span class="asociada-text">Factura N¬∞ {{ f.numeroFactura }}<ng-container *ngIf="f.fechaEmision"> - {{
                  f.fechaEmision }}</ng-container></span>
              <button class="detail-btn small" [class.disabled]="!f.numeroFactura || f.numeroFactura === '0'"
                [disabled]="!f.numeroFactura || f.numeroFactura === '0'"
                (click)="verDetalleFactura(f.numeroFactura)">Ver detalle</button>
            </div>
          </ng-container>
        </div>
      </div>

      <div class="card-footer-actions">
        <button class="btn-outline" *ngIf="c.facturasAsociadas && c.facturasAsociadas.length > 0"
          (click)="openFacturasModal(c)">
          Facturas asociadas
          <span class="badge-count">{{ c.facturasAsociadas.length }}</span>
        </button>
        <button class="detail-btn" (click)="verDetalle(c)">Ver detalle</button>
      </div>

      <div class="card-actions show-on-mobile">
        <!-- Mobile actions now handled by card-footer-actions which is unified -->
      </div>
    </div>
  </div>

  <div class="pagination-row desktop-only" *ngIf="!hasNoResults && totalPages > 1">
    <button class="page-box" *ngFor="let p of pages" [class.active]="p === page" (click)="goToPage(p)">
      {{ p }}
    </button>
  </div>

  <!-- Pager condensado m√≥vil -->
  <div class="mobile-condensed-pager" *ngIf="!hasNoResults && totalPages > 1">
    <div class="pager-node" *ngFor="let p of condensedPager" [class.active]="isPagerActive(p)"
      [class.neighbor]="isPagerNeighbor(p)" (click)="goToPage(p)">
      <span>{{ p }}</span>
    </div>
  </div>
</div>

<div class="facturas-modal" *ngIf="facturasModalVisible">
  <div class="facturas-modal__backdrop" (click)="closeFacturasModal()"></div>
  <div class="facturas-modal__dialog" role="dialog" aria-modal="true">
    <div class="facturas-modal__header">
      <div>
        <h4>Facturas asociadas</h4>
        <p class="subtitle">{{ facturasModalTitle }}</p>
      </div>
      <button class="close-btn" (click)="closeFacturasModal()" aria-label="Cerrar">‚úï</button>
    </div>
    <div class="facturas-modal__list" *ngIf="facturasModalItems.length; else sinFacturas">
      <div class="factura-row" *ngFor="let f of facturasModalItems">
        <div class="factura-info">
          <p class="factura-num">Factura N¬∞ {{ f.numeroFactura }}</p>
          <p class="factura-date" *ngIf="f.fechaEmision">Fecha de emisi√≥n: {{ f.fechaEmision }}</p>
        </div>
        <button class="detail-btn small" [class.disabled]="!f.numeroFactura || f.numeroFactura === '0'"
          [disabled]="!f.numeroFactura || f.numeroFactura === '0'" (click)="verDetalleFactura(f.numeroFactura)">Ver
          detalle</button>
      </div>
    </div>
    <ng-template #sinFacturas>
      <p class="empty-modal">No encontramos facturas para esta compra.</p>
    </ng-template>
  </div>
</div>