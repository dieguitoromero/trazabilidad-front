<div class="mis-compras-wrapper">
  <h2 class="title">Mis Compras</h2>

  <div class="search-row">
    <input
      type="text"
      placeholder="Buscar por N¬∞ de pedido"
      [(ngModel)]="searchTerm"
      (keyup.enter)="buscar()"
      (input)="onInputChange()"
    />
    <button class="search-btn" aria-label="Buscar" (click)="buscar()">
      üîç
    </button>
  </div>

  <div class="empty" *ngIf="hasNoResults">
    <div class="info-icon">i</div>
    <div class="text">No se encontr√≥ documento</div>
  </div>

  <div class="cards" *ngIf="!hasNoResults">
    <div class="card" *ngFor="let c of filteredCompras">
      <div class="card-header">
        <div class="doc-title">
          {{ c.tipoDocumento }} N¬∞ {{ c.numeroDocumento }}
        </div>
  <button class="detail-btn" (click)="verDetalle(c)">Ver detalle</button>
      </div>

      <div class="meta">
        <div class="fecha">Fecha de compra: {{ c.fechaCompra | date:'d MMMM y' : '' : 'es-CL' }}</div>
        <div class="dimensionado-row" *ngIf="c.esDimensionado">
          <span class="badge dimensionado">
            <img src="assets/dimensionado-icon.svg" alt="Dimensionado" />
            Dimensionado
          </span>
        </div>
      </div>

      <div class="entrega-row">
        <span class="icon">
          <img [src]="c.tipoEntrega === 'Despacho a domicilio' ? 'assets/domicilio-icon.svg' : 'assets/tienda-icon.svg'" alt="Entrega" />
        </span>
        <span class="entrega-text">
          {{ c.tipoEntrega }}{{ c.direccionEntrega ? ': ' + c.direccionEntrega : '' }}
        </span>
      </div>

      <div class="stepper hide-on-mobile">
        <div class="step"
             *ngFor="let p of pasos; let i = index"
             [class.completed]="i <= lastReachedIndex(c)"
             [class.current]="i === lastReachedIndex(c)">
          <div class="dot"></div>
          <div class="label">{{ p }}</div>
        </div>
      </div>

      <!-- Mobile: estado actual en una l√≠nea -->
      <div class="estado-movil show-on-mobile">
        <span class="estado-icon"><img src="assets/estado-icon.svg" alt="Estado" /></span>
        <span class="estado-text">Estado: {{ estadoActual(c) }}</span>
      </div>

      <!-- Facturas asociadas (para Nota de Venta) -->
      <div class="asociadas" *ngIf="c.facturasAsociadas && c.facturasAsociadas.length > 0">
        <button type="button" class="asociadas-toggle" (click)="toggleAsociadas(c)">
          <span class="link">Facturas asociadas ({{ c.facturasAsociadas.length }})</span>
          <span class="chev" [class.open]="isAsociadasOpen(c)">‚ñæ</span>
        </button>
        <div class="asociadas-list" *ngIf="isAsociadasOpen(c)">
          <div class="asociada-item" *ngFor="let f of c.facturasAsociadas">
            <span class="dot-bullet">‚Ä¢</span>
            <span class="asociada-text">Factura N¬∞ {{ f.numeroFactura }} - {{ f.fechaEmision | date:'dd-MM-y' }}</span>
            <button class="detail-btn small" (click)="verDetalleFactura(f.numeroFactura)">Ver detalle</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Paginaci√≥n -->
  <div class="pagination-row" *ngIf="!hasNoResults && totalFilteredCount > perPage">
    <button
      class="page-box"
      *ngFor="let p of pages"
      [class.active]="p === page"
      (click)="goToPage(p)">
      {{ p }}
    </button>
  </div>
</div>
